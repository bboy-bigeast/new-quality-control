{% extends 'raw_materials/base.html' %}

{% block title %}原料列表 - 原料管理系统{% endblock %}

{% block page_title %}原料列表{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">原料列表</li>
{% endblock %}

{% block actions %}
<a href="/admin/raw_materials/rawmaterial/add/" class="btn btn-primary" target="_blank">
    <i class="bi bi-plus-circle"></i> 添加原料
</a>
{% endblock %}

{% block content %}
<!-- 筛选表单 -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-filter"></i> 筛选条件
        </h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="material_name" class="form-label">原料名称</label>
                <input type="text" class="form-control" id="material_name" name="material_name" 
                       value="{{ material_name }}" placeholder="输入原料名称">
            </div>
            <div class="col-md-3">
                <label for="supplier" class="form-label">供应商</label>
                <input type="text" class="form-control" id="supplier" name="supplier" 
                       value="{{ supplier }}" placeholder="输入供应商">
            </div>
            <div class="col-md-2">
                <label for="start_date" class="form-label">开始日期</label>
                <input type="date" class="form-control" id="start_date" name="start_date" 
                       value="{{ start_date }}">
            </div>
            <div class="col-md-2">
                <label for="end_date" class="form-label">结束日期</label>
                <input type="date" class="form-control" id="end_date" name="end_date" 
                       value="{{ end_date }}">
            </div>
            <div class="col-md-2">
                <label for="judgment_status" class="form-label">判定状态</label>
                <select class="form-select" id="judgment_status" name="judgment_status">
                    <option value="">全部</option>
                    <option value="合格" {% if judgment_status == '合格' %}selected{% endif %}>合格</option>
                    <option value="不合格" {% if judgment_status == '不合格' %}selected{% endif %}>不合格</option>
                    <option value="待判定" {% if judgment_status == '待判定' %}selected{% endif %}>待判定</option>
                </select>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> 搜索
                </button>
                <a href="{% url 'raw_materials:raw_material_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-clockwise"></i> 重置
                </a>
            </div>
        </form>
    </div>
</div>

<!-- 原料列表 -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">原料记录 ({{ materials.count }})</h5>
        <div>
            <span class="badge bg-success">合格: {{ materials|filter_judgment_status:'合格'|length }}</span>
            <span class="badge bg-danger">不合格: {{ materials|filter_judgment_status:'不合格'|length }}</span>
            <span class="badge bg-warning text-dark">待判定: {{ materials|filter_judgment_status:'待判定'|length }}</span>
        </div>
    </div>
    <div class="card-body">
        {% if materials %}
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead>
                    <tr>
                        <th>原料名称</th>
                        <th>原料批号</th>
                        <th>供应商</th>
                        <th>检测人</th>
                        <th>测试日期</th>
                        <th>判定结果</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for material in materials %}
                    <tr>
                        <td>{{ material.material_name }}</td>
                        <td>
                            <strong>{{ material.material_batch }}</strong>
                            {% if material.sample_category %}
                            <br>
                            <small class="text-muted">{{ material.sample_category }}</small>
                            {% endif %}
                        </td>
                        <td>{{ material.supplier }}</td>
                        <td>{{ material.inspector }}</td>
                        <td>{{ material.test_date }}</td>
                        <td>
                            {% if material.judgment_status == '合格' %}
                            <span class="badge bg-success judgment-badge">合格</span>
                            {% elif material.judgment_status == '不合格' %}
                            <span class="badge bg-danger judgment-badge">不合格</span>
                            {% else %}
                            <span class="badge bg-warning text-dark judgment-badge">待判定</span>
                            {% endif %}
                            {% if material.final_judgment %}
                            <br>
                            <small class="text-muted">{{ material.final_judgment }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'raw_materials:raw_material_detail' material.pk %}" 
                                   class="btn btn-outline-primary" title="查看详情">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="/admin/raw_materials/rawmaterial/{{ material.pk }}/change/" 
                                   class="btn btn-outline-secondary" target="_blank" title="编辑">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" class="btn btn-outline-info" 
                                        onclick="copyMaterialInfo('{{ material.material_name }}', '{{ material.material_batch }}', '{{ material.supplier }}')"
                                        title="复制信息">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
            <h5 class="mt-3">暂无原料数据</h5>
            <p class="text-muted">请点击"添加原料"按钮添加新的原料记录</p>
            <a href="/admin/raw_materials/rawmaterial/add/" class="btn btn-primary" target="_blank">
                <i class="bi bi-plus-circle"></i> 添加原料
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 复制原料信息
    function copyMaterialInfo(materialName, materialBatch, supplier) {
        const text = `原料名称: ${materialName}\n原料批号: ${materialBatch}\n供应商: ${supplier}`;
        copyToClipboard(text, {
            successMessage: '原料信息已复制到剪贴板',
            errorMessage: '复制失败，请手动复制文本',
            showToast: true,
            toastPosition: 'top-right'
        });
    }

    // 自定义过滤器（在模板中使用的简单版本）
    function filter_judgment_status(materials, status) {
        return materials.filter(m => m.judgment_status === status);
    }

    // 将过滤器函数添加到全局作用域（在真实环境中应该在Django模板过滤器中实现）
    window.filter_judgment_status = filter_judgment_status;
</script>
{% endblock %}
